<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bandit Perfumes - Checkout (Catálogo + PayPal Sandbox)</title>
  <style>
    body { font-family: system-ui, Arial; margin: 24px; max-width: 980px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    label { display:block; font-weight: 700; margin-top: 10px; }
    input, select, textarea, button { width: 100%; padding: 10px; margin-top: 6px; box-sizing: border-box; }
    button { cursor: pointer; font-weight: 800; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-top: 16px; }
    .muted { color: #666; font-size: 14px; }
    pre { background: #0b1020; color: #d7e0ff; padding: 12px; border-radius: 10px; overflow:auto; }
    .ok { color: #0a7; font-weight: 800; }
    .bad { color: #c00; font-weight: 800; }
    #paypal-buttons { margin-top: 10px; }
    .disabled { opacity: 0.5; pointer-events: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    td, th { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
  </style>
</head>
<body>
  <h1>Checkout (Catálogo + PayPal Buttons - Sandbox)</h1>
  <p class="muted">
    Flujo: <b>cargar catálogo</b> → <b>preparar compra (backend calcula precio)</b> → <b>PayPal approve</b> → <b>capture</b>.
  </p>

  <div class="card">
    <h2>Config</h2>
    <div class="row">
      <div>
        <label>API Base</label>
        <input id="apiBase" value="http://localhost:3001" />
      </div>
      <div>
        <label>Currency</label>
        <input id="currency" value="MXN" />
      </div>
    </div>

    <label>PayPal Client ID (Sandbox)</label>
      <input id="paypalClientId" placeholder="Pega tu Client ID de sandbox" />

    <div style="margin-top: 12px;">
      <button id="btnLoadSdk">1) Cargar PayPal SDK</button>
      <button id="btnLoadProducts">2) Cargar productos</button>
    </div>

    <div class="muted">Tip: corre el frontend en <b>http://localhost:3000</b> para evitar líos.</div>
  </div>

  <div class="card">
    <h2>Carrito (simple)</h2>

    <div class="row">
      <div>
        <label>Producto</label>
        <select id="productSelect"></select>
      </div>
      <div>
        <label>Cantidad</label>
        <input id="qty" type="number" min="1" max="99" value="1" />
      </div>
    </div>

    <div style="margin-top: 10px;">
      <button id="btnAdd" disabled>Agregar al carrito</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>ProductId</th>
          <th>Nombre</th>
          <th>Precio</th>
          <th>Qty</th>
          <th>Subtotal</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="cartBody"></tbody>
      <tfoot>
        <tr>
          <th colspan="4">Total</th>
          <th id="cartTotal">$0.00</th>
          <th></th>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="card">
    <h2>Buyer</h2>
    <div class="row">
      <div>
        <label>Nombre</label>
        <input id="name" value="Test Buyer" />
      </div>
      <div>
        <label>Teléfono</label>
        <input id="phone" value="2220000000" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Email</label>
        <input id="email" value="buyer@test.com" />
      </div>
      <div>
        <label>Dirección (opcional)</label>
        <input id="address" value="Calle 123" />
      </div>
    </div>

    <label>Notas (opcional)</label>
    <textarea id="notes" rows="2">Compra de prueba</textarea>

    <button id="btnPrepare" disabled style="margin-top:12px;">3) Preparar compra (crear orden backend)</button>

    <div style="margin-top: 10px;">
      <div><b>purchaseId:</b> <span id="purchaseId" class="muted">(vacío)</span></div>
      <div><b>paypalOrderId:</b> <span id="paypalOrderId" class="muted">(vacío)</span></div>
    </div>

    <h3 style="margin-top:14px;">PayPal Buttons</h3>
    <div id="paypal-buttons" class="disabled"></div>
    <div class="muted">Se habilitan después de “Preparar compra”.</div>
  </div>

  <div class="card">
    <h2>Log</h2>
    <div id="status" class="muted">Listo.</div>
    <pre id="log">{}</pre>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const state = {
    sdkLoaded: false,
    products: [],
    cart: [], // [{productId, name, priceCents, qty}]
    purchaseId: null,
    paypalOrderId: null,
    buttons: null,
  };

  function setStatus(text, ok=true) {
    $("status").textContent = text;
    $("status").className = ok ? "ok" : "bad";
  }
  function setLog(obj) { $("log").textContent = JSON.stringify(obj, null, 2); }

  function centsToMoney(c) {
    const n = Number(c || 0) / 100;
    return n.toLocaleString("es-MX", { style: "currency", currency: $("currency").value.trim() || "MXN" });
  }

  async function apiFetch(path, options) {
    const base = $("apiBase").value.trim().replace(/\/+$/, "");
    const res = await fetch(base + path, {
      headers: { "Content-Type": "application/json", ...(options?.headers||{}) },
      ...options,
    });
    const json = await res.json().catch(() => ({}));
    if (!res.ok) {
      const msg = json?.error?.message || json?.message || `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return json;
  }

  function loadPaypalSdk(clientId, currency) {
    return new Promise((resolve, reject) => {
      if (window.paypal) return resolve();
      const script = document.createElement("script");
      script.src = `https://www.sandbox.paypal.com/sdk/js?client-id=${encodeURIComponent(clientId)}&currency=${encodeURIComponent(currency)}&intent=capture`;
      script.async = true;
      script.onload = () => resolve();
      script.onerror = () => reject(new Error("No se pudo cargar el PayPal SDK"));
      document.head.appendChild(script);
    });
  }

  function renderProductsSelect() {
    const sel = $("productSelect");
    sel.innerHTML = "";
    for (const p of state.products) {
      const opt = document.createElement("option");
      opt.value = String(p.id);
      opt.textContent = `${p.name} (id=${p.id}) - ${centsToMoney(p.price_cents)}`;
      sel.appendChild(opt);
    }
  }

  function recalcCartUI() {
    const body = $("cartBody");
    body.innerHTML = "";

    let total = 0;
    state.cart.forEach((it, idx) => {
      const subtotal = it.priceCents * it.qty;
      total += subtotal;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${it.productId}</td>
        <td>${it.name}</td>
        <td>${centsToMoney(it.priceCents)}</td>
        <td>${it.qty}</td>
        <td>${centsToMoney(subtotal)}</td>
        <td><button data-idx="${idx}">Quitar</button></td>
      `;
      body.appendChild(tr);
    });

    $("cartTotal").textContent = centsToMoney(total);

    body.querySelectorAll("button[data-idx]").forEach(btn => {
      btn.addEventListener("click", () => {
        const idx = Number(btn.getAttribute("data-idx"));
        state.cart.splice(idx, 1);
        recalcCartUI();
      });
    });

    $("btnPrepare").disabled = !(state.sdkLoaded && state.cart.length > 0);
  }

  function resetButtons() {
    $("paypal-buttons").innerHTML = "";
    state.buttons = null;
    $("paypal-buttons").classList.add("disabled");
  }

  async function renderButtons() {
    if (!window.paypal) throw new Error("SDK no cargado");
    if (!state.paypalOrderId) throw new Error("No hay paypalOrderId");
    if (!state.purchaseId) throw new Error("No hay purchaseId");

    resetButtons();
    $("paypal-buttons").classList.remove("disabled");

    state.buttons = window.paypal.Buttons({
      createOrder: () => state.paypalOrderId,

      onApprove: async (data) => {
        try {
          setStatus("Aprobado en PayPal. Capturando...", true);
          setLog({ onApprove: data });

          const json = await apiFetch("/v1/purchases/capture", {
            method: "POST",
            body: JSON.stringify({ purchaseId: state.purchaseId })
          });

          setLog({ onApprove: data, captureResponse: json });
          setStatus("Pago capturado ✅ (status=PAID).", true);
        } catch (e) {
          setStatus("Error capturando: " + e.message, false);
        }
      },

      onCancel: (data) => {
        setStatus("Pago cancelado.", false);
        setLog({ onCancel: data });
      },

      onError: (err) => {
        setStatus("PayPal Error: " + (err?.message || String(err)), false);
        setLog({ paypalError: err });
      },
    });

    await state.buttons.render("#paypal-buttons");
  }

  // --- botones ---
  $("btnLoadSdk").addEventListener("click", async () => {
    try {
      setStatus("Cargando PayPal SDK...", true);
      const clientId = $("paypalClientId").value.trim();
      const currency = $("currency").value.trim() || "MXN";
      if (!clientId) throw new Error("Pega tu Client ID sandbox");

      await loadPaypalSdk(clientId, currency);
      state.sdkLoaded = true;

      $("btnAdd").disabled = false;
      $("btnPrepare").disabled = state.cart.length === 0;
      setStatus("SDK cargado ✅", true);
    } catch (e) {
      setStatus("Error SDK: " + e.message, false);
    }
  });

  $("btnLoadProducts").addEventListener("click", async () => {
    try {
      setStatus("Cargando productos...", true);
      const json = await apiFetch("/v1/products", { method: "GET" });
      setLog(json);

      state.products = json.data.products || [];
      if (state.products.length === 0) throw new Error("No hay productos activos en DB");

      renderProductsSelect();
      setStatus("Productos cargados ✅", true);
    } catch (e) {
      setStatus("Error productos: " + e.message, false);
    }
  });

  $("btnAdd").addEventListener("click", () => {
    const pid = Number($("productSelect").value);
    const qty = Math.max(1, Math.min(99, Number($("qty").value)));

    const p = state.products.find(x => Number(x.id) === pid);
    if (!p) return;

    // si ya existe, suma qty
    const existing = state.cart.find(x => x.productId === pid);
    if (existing) existing.qty += qty;
    else {
      state.cart.push({
        productId: pid,
        name: p.name,
        priceCents: Number(p.price_cents),
        qty
      });
    }

    recalcCartUI();
  });

  $("btnPrepare").addEventListener("click", async () => {
    try {
      if (!state.sdkLoaded) throw new Error("Carga el SDK primero");
      if (state.cart.length === 0) throw new Error("Carrito vacío");

      setStatus("Preparando compra en backend (calculando precio por productId)...", true);
      setLog({});
      resetButtons();

      const currency = $("currency").value.trim() || "MXN";
      const payload = {
        buyer: {
          email: $("email").value.trim(),
          name: $("name").value.trim(),
          phone: $("phone").value.trim(),
          address: $("address").value.trim() || undefined,
          notes: $("notes").value.trim() || undefined,
        },
        items: state.cart.map(it => ({ productId: it.productId, qty: it.qty })),
        currency
      };

      const json = await apiFetch("/v1/purchases/create-paypal-order", {
        method: "POST",
        body: JSON.stringify(payload)
      });

      setLog(json);

      state.purchaseId = json.data.purchaseId;
      state.paypalOrderId = json.data.paypalOrderId;

      $("purchaseId").textContent = state.purchaseId || "(vacío)";
      $("paypalOrderId").textContent = state.paypalOrderId || "(vacío)";

      if (!state.paypalOrderId) throw new Error("No llegó paypalOrderId");

      setStatus("Orden creada ✅ Usa PayPal Buttons para pagar.", true);
      await renderButtons();
    } catch (e) {
      setStatus("Error preparar: " + e.message, false);
    }
  });

  // inicial
  recalcCartUI();
</script>
</body>
</html>
